# 因子化触发器攻击 - MR增强版 + Enhanced Evaluation（持久性测试）
# Single-shot attack + Model Replacement + 完整评估

# ============= 基础配置 =============
dataset: 'cifar10'
seed: 42
epochs: 200                   # 增加到500轮以观察持久性

# ============= 【关键】持久性测试配置 =============
poison_start_epoch: 340        # CIFAR-10在340轮开始投毒（模型已收敛）
poison_stop_epoch: 341         # 341轮停止（只投毒1轮，single-shot）
poison_epochs: 500             # 总轮数

# ============= 联邦学习配置 =============
num_total_participants: 100
num_sampled_participants: 20   # ⚠️ 增加到20以确保single-shot有效
                               # 因为有3个恶意客户端需要在1轮内都被采样
num_adversaries: 3
sample_method: 'random'
dirichlet_alpha: 0.9

# ============= 训练配置 =============
lr: 0.1                        # 恢复到标准学习率（持久性测试需要快速收敛）
target_lr: 0.1
lr_method: 'constant'          # 使用常数学习率
lr_decay_epochs: []

momentum: 0.9
decay: 0.0001                  # 标准权重衰减
batch_size: 64
test_batch_size: 1024
retrain_times: 2
attacker_retrain_times: 6      # 持久性测试建议增加到6

# ============= 【新增】Model Replacement配置 =============
use_model_replacement: true
scale_factor_gamma: 50.0       # γ降低到50（因为采样数增加到20）
                               # γ = 100 / (20/10) = 50

# MR自适应模式
mr_adaptive: true              # 启用自适应，让系统自动调整
mr_min_scale: 10.0
mr_max_scale: 100.0

# ============= 【新增】恶意学习率配置 =============
malicious_lr: 0.05             # 持久性测试使用0.05

# ============= 聚合方法配置 =============
agg_method: 'avg'
clip_factor: 1

# ============= 因子化攻击配置 =============
attacker_method: 'factorized'

k_of_m_k: 2
k_of_m_m: 4                    # 2-of-4（比2-of-3更难检测）

# 动态强度
initial_intensity: 0.5         # 持久性测试使用固定强度
final_intensity: 0.5

# 任务分离
task_separation_weight: 0.0    # 持久性测试通常不用任务分离

# 轮换策略
rotation_strategy: 'adversary_specific'
rotation_frequency: 1

# 攻击目标
target_class: 2
bkd_ratio: 0.03125             # 持久性测试使用3.125%（每批次2个样本）

# ============= 【新增】Enhanced Evaluation配置 =============
eval_freq: 5                   # 每5轮评估

# 评估模式
evaluation:
  main_task: true
  attack_success: true
  
  # 隐蔽性评估
  stealthiness:
    enabled: true
    compare_benign: true
    compute_cosine_sim: true
    analyze_distribution: true
  
  # 触发器评估
  trigger_quality:
    enabled: true
    compute_psnr: true
    compute_ssim: true
    num_samples: 100
  
  # 因子多样性和轮换评估
  factor_diversity: true
  rotation_effectiveness: true
  
  # 基线对比（在关键轮次）
  baseline_comparison:
    enabled: true
    methods:
      - 'BadNets'
      - 'DBA'
      - 'Neurotoxin'
      - 'Factorized (2-of-4)'
    compare_epochs: [340, 380, 420, 460, 500]  # 投毒后的关键轮次

# 保存评估历史
save_evaluation_history: true
evaluation_history_path: './results/persistence_mr_enhanced/eval_history.json'

# ============= 可视化配置 =============
visualization:
  enabled: true
  save_interval: 20
  save_dir: './visualizations_persistence'
  
  # 趋势图（持久性测试的核心）
  trends:
    enabled: true
    plot_freq: 20
    metrics:
      - 'main_accuracy'
      - 'average_asr'
      - 'l2_ratio'
      - 'cosine_similarity'
      - 'factor_diversity'
    
    # 【关键】持久性分析特殊配置
    persistence_analysis:
      enabled: true
      baseline_epoch: 340       # 投毒轮次
      check_epochs: [340, 380, 420, 460, 500]  # ASR-0, ASR-40, ASR-80, ASR-120, ASR-160
      
  # 触发器可视化
  trigger_visualization:
    enabled: true
    save_epochs: [340, 380, 420, 460, 500]
    num_samples: 10

# ============= 输出配置 =============
environment_name: 'persistence_mr_enhanced'
save_model: true
save_on_epochs: [100, 200, 300, 340, 380, 420, 460, 500]
results_dir: './results/persistence_mr_enhanced'

# ============= 日志配置 =============
logging:
  level: 'INFO'
  save_log: true
  log_path: './results/persistence_mr_enhanced/training.log'
  verbose:
    enabled: false
    log_updates: false
    log_metrics: true

# ============= 说明 =============
# 持久性测试版本的特点：
#
# 1. Single-shot攻击：
#    - 只在Round 340投毒1轮
#    - 观察后门在160轮后的持久性
#
# 2. Model Replacement：
#    - γ=50（自适应调整）
#    - 确保single-shot有效
#
# 3. Enhanced Evaluation：
#    - 完整的隐蔽性度量
#    - 持久性曲线绘制
#    - 与基线方法全面对比
#
# 4. 预期结果：
#    - Round 340: ASR ~95%（投毒轮）
#    - Round 380: ASR ~85%（+40轮）
#    - Round 420: ASR ~80%（+80轮）
#    - Round 460: ASR ~75%（+120轮）
#    - Round 500: ASR ~70%（+160轮，仍然很高！）
#
# 5. 与基线对比：
#    - BadNets: ASR-120约5-10%（快速衰减）
#    - DBA: ASR-120约25-35%（中等持久性）
#    - Ours: ASR-120约75%（强持久性）
#
# 使用方法：
# python train_with_persistence_test_FIXED.py \
#     --gpu 0 \
#     --params tmp_mr.yaml \
#     --seed 42
#
# 关键优势：
# - Single-shot + MR = 强攻击 + 高隐蔽性
# - Enhanced Evaluation = 完整的实验分析
# - 适合SCI论文发表
